<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>مصحف القارئ محمد أيوب</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --accent: #0ea5e9;
        --accent-dark: #0f172a;
        --verse-font-size: 1.35rem;
      }

      body {
        font-family: "Cairo", system-ui, sans-serif;
        background: radial-gradient(circle at top, #f8fafc, #ffffff 60%);
        color: #0f172a;
        transition: background 0.3s ease, color 0.3s ease;
      }

      body.dark-mode {
        color-scheme: dark;
        background: radial-gradient(circle at top, #0f172a, #020617 60%);
        color: #e2e8f0;
      }

      .card,
      .floating-panel,
      .hero {
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: 1.25rem;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      }

      body.dark-mode .card,
      body.dark-mode .floating-panel,
      body.dark-mode .hero {
        background: rgba(15, 23, 42, 0.8);
        border-color: rgba(148, 163, 184, 0.25);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
      }

      .hero {
        background: linear-gradient(135deg, #012a4a, #023047);
        color: #fff;
        padding: 3rem;
        position: relative;
        overflow: hidden;
      }

      .hero::after {
        content: "";
        position: absolute;
        inset: 1.25rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 1rem;
        pointer-events: none;
      }

      .section-title {
        font-weight: 700;
        font-size: 1.1rem;
      }

      .letter-spacing {
        letter-spacing: 0.35rem;
      }

      .surah-card {
        border-radius: 1rem;
        border: 1px solid transparent;
        transition: 0.2s ease;
        cursor: pointer;
      }

      .surah-card.active,
      .surah-card:hover {
        border-color: rgba(14, 165, 233, 0.5);
        box-shadow: 0 10px 20px rgba(14, 165, 233, 0.15);
        transform: translateY(-2px);
      }

      .verses-wrapper {
        max-height: 75vh;
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      .verse-card {
        border-radius: 1rem;
        border: 1px solid rgba(2, 48, 71, 0.08);
        margin-bottom: 1rem;
        padding: 1.25rem;
      }

      body.dark-mode .verse-card {
        border-color: rgba(148, 163, 184, 0.25);
      }

      .verse-card.playing {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
      }

      .verse-text {
        font-family: "Amiri", serif;
        font-size: var(--verse-font-size);
        line-height: 2.4rem;
      }

      .verse-card.highlight {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.25);
      }

      .btn-pill {
        border-radius: 999px;
      }

      .floating-panel {
        position: sticky;
        top: 1.5rem;
      }

      .player-meta {
        font-size: 0.9rem;
      }

      .status-pill {
        border-radius: 999px;
        padding: 0.35rem 0.85rem;
        font-size: 0.85rem;
        font-weight: 700;
      }

      .status-ok {
        background: rgba(16, 185, 129, 0.15);
        color: #047857;
      }

      .status-bad {
        background: rgba(248, 113, 113, 0.15);
        color: #b91c1c;
      }

      body.dark-mode .status-ok {
        background: rgba(16, 185, 129, 0.2);
        color: #86efac;
      }

      body.dark-mode .status-bad {
        background: rgba(248, 113, 113, 0.2);
        color: #fecaca;
      }

      .bookmark-pill,
      .history-pill {
        border-radius: 999px;
        border: 1px dashed rgba(2, 48, 71, 0.3);
        padding: 0.3rem 0.75rem;
      }

      body.dark-mode .bookmark-pill,
      body.dark-mode .history-pill {
        border-color: rgba(226, 232, 240, 0.25);
      }

      #dailyAyahArabic {
        cursor: pointer;
      }

      .search-result {
        border: 1px dashed rgba(2, 48, 71, 0.3);
        border-radius: 0.85rem;
        padding: 1rem;
      }

      body.dark-mode .search-result {
        border-color: rgba(226, 232, 240, 0.25);
        background: rgba(15, 23, 42, 0.6);
      }

      .search-result em {
        background: #fbbf24;
        padding: 0 0.2rem;
        border-radius: 0.3rem;
        font-style: normal;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.05);
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(14, 165, 233, 0.5);
        border-radius: 999px;
      }

      body.dark-mode ::-webkit-scrollbar-track {
        background: rgba(226, 232, 240, 0.1);
      }
    </style>
  </head>
  <body>
    <header class="container py-4">
      <div class="hero text-center text-md-start">
        <div class="row align-items-center g-4">
          <div class="col-md-8">
            <p class="text-uppercase mb-2 letter-spacing small opacity-75">
              مصحف شامل
            </p>
            <h1 class="display-5 fw-bold mb-3">
              استمع وتدبر مع الشيخ <span class="text-warning">محمد أيوب</span>
            </h1>
            <p class="lead mb-4">
              تجربة قراءة واستماع حديثة تعتمد على واجهات برمجة تطبيقات Qur'an.com
              وتدعم التخصيص، الحفظ، والبحث الشامل في المصحف الشريف.
            </p>
            <div class="d-flex flex-wrap gap-2">
              <span class="badge bg-light text-dark">
                <i class="bi bi-music-note-beamed me-1"></i> تلاوة عالية الجودة
              </span>
              <span class="badge bg-light text-dark">
                <i class="bi bi-translate me-1"></i> تراجم متعددة
              </span>
              <span class="badge bg-light text-dark">
                <i class="bi bi-bookmark-heart me-1"></i> إشارات مرجعية ذكية
              </span>
            </div>
          </div>
          <div class="col-md-4 text-md-end">
            <div class="rounded-4 bg-white bg-opacity-25 p-4">
              <p class="text-uppercase small mb-1">القارئ</p>
              <h2 class="fw-bold">الشيخ محمد أيوب</h2>
              <p class="small mb-0">
                إمام المسجد النبوي سابقًا، بصوت خاشع ومرتّل متاح عبر شبكة التلاوات
                الإسلامية.
              </p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="container pb-5">
      <section class="row g-4">
        <div class="col-lg-4">
          <div class="floating-panel card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="section-title mb-0">التحكم</h2>
              <button id="themeToggle" class="btn btn-outline-light btn-pill">
                <i class="bi bi-moon-stars"></i>
              </button>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">ابحث عن سورة</label>
              <input
                type="search"
                id="chapterSearch"
                class="form-control"
                placeholder="اكتب اسم السورة"
              />
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">الترجمة</label>
              <select id="translationSelect" class="form-select"></select>
            </div>
            <div class="mb-4">
              <label class="form-label fw-semibold">حجم الخط</label>
              <input
                type="range"
                id="fontSizeRange"
                class="form-range"
                min="1"
                max="2"
                step="0.05"
                value="1.35"
              />
            </div>
            <div class="mb-3">
              <button id="globalSearchBtn" class="btn btn-pill w-100 btn-outline-primary">
                <i class="bi bi-search ms-1"></i>
                بحث شامل في المصحف
              </button>
            </div>
            <div class="mb-0">
              <button id="exportBookmarks" class="btn btn-pill w-100 btn-outline-success">
                <i class="bi bi-download ms-1"></i>
                تصدير الإشارات المرجعية
              </button>
            </div>
          </div>

          <div class="card p-4 mb-4">
            <h2 class="section-title mb-3">آخر السور المفتوحة</h2>
            <div id="historyContainer" class="d-flex flex-wrap gap-2 small"></div>
            <button class="btn btn-link text-danger mt-2 p-0" id="clearHistory">
              مسح السجل
            </button>
          </div>

          <div class="card p-4 mb-4">
            <h2 class="section-title mb-3">آية اليوم</h2>
            <p class="mb-2" id="dailyAyahArabic"></p>
            <p class="text-muted small" id="dailyAyahTranslation"></p>
            <button class="btn btn-pill btn-outline-secondary w-100" id="refreshDaily">
              <i class="bi bi-shuffle ms-1"></i>
              آية جديدة
            </button>
          </div>

          <div class="card p-4">
            <h2 class="section-title mb-3">الحالة</h2>
            <div class="status-item mb-2">
              <span class="d-block small text-muted">قائمة السور</span>
              <span id="statusChapters" class="status-pill">—</span>
            </div>
            <div class="status-item mb-2">
              <span class="d-block small text-muted">الآيات</span>
              <span id="statusVerses" class="status-pill">—</span>
            </div>
            <div class="status-item mb-2">
              <span class="d-block small text-muted">بحث المصحف</span>
              <span id="statusSearch" class="status-pill">—</span>
            </div>
            <div class="status-item">
              <span class="d-block small text-muted">الآية العشوائية</span>
              <span id="statusRandom" class="status-pill">—</span>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card p-4 mb-4">
            <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 mb-4">
              <div class="flex-grow-1">
                <label class="form-label fw-semibold">قائمة السور</label>
                <input
                  type="search"
                  class="form-control"
                  id="chapterQuickSearch"
                  placeholder="ابحث بسرعة في السور"
                />
              </div>
              <div>
                <select id="revelationFilter" class="form-select">
                  <option value="all">كل السور</option>
                  <option value="Meccan">مكية</option>
                  <option value="Medinan">مدنية</option>
                </select>
              </div>
            </div>
            <div class="row g-3" id="chaptersContainer"></div>
          </div>

          <div class="card p-4 mb-4">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
              <h2 class="section-title mb-0" id="currentSurahTitle">اختر سورة</h2>
              <span class="badge bg-primary" id="currentSurahInfo"></span>
            </div>
            <div class="mb-3">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input
                  type="search"
                  class="form-control"
                  id="verseSearch"
                  placeholder="ابحث داخل السورة"
                />
              </div>
            </div>
            <div class="verses-wrapper" id="versesContainer"></div>
            <div class="text-center" id="loadMoreContainer" hidden>
              <button class="btn btn-outline-primary btn-pill" id="loadMoreVerses">
                تحميل المزيد من الآيات
              </button>
            </div>
          </div>

          <div class="card p-4 mb-4" id="searchPanel" hidden>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="section-title mb-0">نتائج البحث الشامل</h2>
              <button class="btn btn-link text-danger p-0" id="closeSearch">إغلاق</button>
            </div>
            <div id="searchResults" class="d-grid gap-3"></div>
          </div>

          <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="section-title mb-0">الإشارات المرجعية</h2>
              <button class="btn btn-sm btn-outline-danger btn-pill" id="clearBookmarks">
                مسح الكل
              </button>
            </div>
            <div id="bookmarksContainer" class="d-flex flex-column gap-2 small"></div>
          </div>
        </div>
      </section>
    </main>

    <footer class="border-top py-4">
      <div class="container d-flex flex-column flex-md-row gap-3 justify-content-between align-items-center">
        <div>
          <span class="fw-semibold">مصحف محمد أيوب</span>
          <span class="text-muted small">يعتمد على API Qur'an.com و Islamic.network</span>
        </div>
        <div class="player-meta text-center text-md-end flex-grow-1 w-100">
          <div class="d-flex flex-column gap-2">
            <div class="d-flex flex-wrap align-items-center gap-2 justify-content-center justify-content-md-end">
              <div class="btn-group" role="group" aria-label="Player controls">
                <button class="btn btn-outline-secondary" id="prevVerseBtn" title="الآية السابقة">
                  <i class="bi bi-skip-backward-fill"></i>
                </button>
                <button class="btn btn-outline-primary" id="playCurrentVerse" title="تشغيل الآية الحالية">
                  <i class="bi bi-play-fill"></i>
                </button>
                <button class="btn btn-outline-secondary" id="nextVerseBtn" title="الآية التالية">
                  <i class="bi bi-skip-forward-fill"></i>
                </button>
              </div>
              <button class="btn btn-outline-success btn-pill" id="autoAdvanceToggle">
                التشغيل المتتالي: مفعل
              </button>
            </div>
            <audio id="globalAudio" controls preload="none"></audio>
          </div>
          <div class="small mt-1" id="playerStatus"></div>
        </div>
      </div>
    </footer>

    <script>
      const API_BASE = "https://api.quran.com/api/v4";
      const AUDIO_CDN = "https://cdn.islamic.network/quran/audio/128/ar.muhammadayyoub";

      const state = {
        chapters: [],
        translationId: 20,
        currentChapter: null,
        currentVerses: [],
        currentVerseIndex: -1,
        autoAdvance: true,
        versePagination: { perPage: 20, currentPage: 1, hasMore: false },
        bookmarks: [],
        history: [],
        theme: "light",
        controllers: {
          verses: null,
          search: null,
          random: null,
        },
      };

      const el = (id) => document.getElementById(id);

      const statusMap = {
        chapters: el("statusChapters"),
        verses: el("statusVerses"),
        search: el("statusSearch"),
        random: el("statusRandom"),
      };

      async function apiRequest(path, { signal, params } = {}) {
        const url = new URL(`${API_BASE}${path}`);
        if (params) Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
        for (let attempt = 0; attempt < 3; attempt++) {
          try {
            const response = await fetch(url, { signal });
            if (!response.ok) {
              if ([409, 429, 500].includes(response.status) && attempt < 2) {
                await new Promise((res) => setTimeout(res, 500 * (attempt + 1)));
                continue;
              }
              throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
          } catch (error) {
            if (error.name === "AbortError") throw error;
            if (attempt === 2) throw error;
            await new Promise((res) => setTimeout(res, 500 * (attempt + 1)));
          }
        }
      }

      function updateStatus(key, ok = true, text = ok ? "جاهز" : "خطأ") {
        const target = statusMap[key];
        if (!target) return;
        target.classList.toggle("status-ok", ok);
        target.classList.toggle("status-bad", !ok);
        target.textContent = text;
      }

      function persistState() {
        const fontSize = getComputedStyle(document.documentElement)
          .getPropertyValue("--verse-font-size")
          .trim();
        localStorage.setItem(
          "quranSettings",
          JSON.stringify({
            translationId: state.translationId,
            theme: state.theme,
            bookmarks: state.bookmarks,
            history: state.history,
            fontSize,
            autoAdvance: state.autoAdvance,
          })
        );
      }

      function restoreState() {
        const saved = JSON.parse(localStorage.getItem("quranSettings") || "{}");
        if (saved.translationId) state.translationId = saved.translationId;
        if (saved.theme) setTheme(saved.theme, false);
        if (saved.bookmarks) state.bookmarks = saved.bookmarks;
        if (saved.history) state.history = saved.history;
        if (typeof saved.autoAdvance === "boolean") state.autoAdvance = saved.autoAdvance;
        if (saved.fontSize) {
          document.documentElement.style.setProperty("--verse-font-size", saved.fontSize);
          el("fontSizeRange").value = parseFloat(saved.fontSize);
        }
        renderBookmarks();
        renderHistory();
      }

      function setTheme(mode, persist = true) {
        state.theme = mode;
        document.body.classList.toggle("dark-mode", mode === "dark");
        document.documentElement.style.setProperty(
          "color-scheme",
          mode === "dark" ? "dark" : "light"
        );
        el("themeToggle").innerHTML =
          mode === "dark" ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon-stars"></i>';
        if (persist) persistState();
      }

      function renderChapters(list = state.chapters) {
        const container = el("chaptersContainer");
        container.innerHTML = "";
        if (!list.length) {
          container.innerHTML = '<div class="text-center text-muted">لا توجد نتائج.</div>';
          return;
        }
        list.forEach((chapter) => {
          const card = document.createElement("div");
          card.className = "col-sm-6 col-xl-4";
          card.innerHTML = `
            <div class="surah-card p-3 h-100 ${
              state.currentChapter?.id === chapter.id ? "active" : ""
            }" data-id="${chapter.id}">
              <div class="d-flex justify-content-between mb-2">
                <strong>${chapter.name_arabic}</strong>
                <span class="badge bg-primary">${chapter.verses_count}</span>
              </div>
              <div class="text-muted small">${chapter.name_simple}</div>
              <div class="text-muted small">${
                chapter.revelation_place === "Meccan" ? "مكية" : "مدنية"
              }</div>
            </div>`;
          card.querySelector(".surah-card").addEventListener("click", () => loadSurah(chapter.id));
          container.appendChild(card);
        });
      }

      function renderVerses(verses, append = false) {
        const container = el("versesContainer");
        if (!append) {
          container.innerHTML = "";
          state.currentVerses = [];
          state.currentVerseIndex = -1;
        }
        verses.forEach((verse) => {
          const card = document.createElement("div");
          card.className = "verse-card";
          card.dataset.verseKey = verse.verse_key;
          card.dataset.verseId = verse.id;
          card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <span class="badge bg-light text-dark">${state.currentChapter?.name_arabic} • ${
            verse.verse_key
          }</span>
              </div>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary" data-action="play">
                  <i class="bi bi-play-fill"></i>
                </button>
                <button class="btn btn-outline-secondary" data-action="copy">
                  <i class="bi bi-clipboard"></i>
                </button>
                <button class="btn btn-outline-warning" data-action="bookmark">
                  <i class="bi bi-bookmark"></i>
                </button>
                <button class="btn btn-outline-success" data-action="download" title="تحميل التلاوة">
                  <i class="bi bi-download"></i>
                </button>
              </div>
            </div>
            <p class="verse-text mb-2">${verse.text_uthmani}</p>
            <p class="text-muted small mb-0">${verse.translations?.[0]?.text || ""}</p>`;
          card.querySelectorAll("button").forEach((btn) =>
            btn.addEventListener("click", (event) => handleVerseAction(event, verse))
          );
          container.appendChild(card);
        });
        state.currentVerses = append
          ? [...state.currentVerses, ...verses]
          : [...verses];
        updatePlayingVerseStyles();
        updatePlayerControls();
      }

      function renderBookmarks() {
        const container = el("bookmarksContainer");
        container.innerHTML = "";
        if (!state.bookmarks.length) {
          container.innerHTML = '<p class="text-muted mb-0">لا توجد إشارات بعد.</p>';
          return;
        }
        state.bookmarks.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "bookmark-pill d-flex justify-content-between align-items-center";
          div.innerHTML = `
            <span>${item.label}</span>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" data-index="${index}" data-action="open">
                فتح
              </button>
              <button class="btn btn-sm btn-outline-danger" data-index="${index}" data-action="remove">
                حذف
              </button>
            </div>`;
          div.querySelectorAll("button").forEach((btn) =>
            btn.addEventListener("click", (e) => handleBookmarkAction(e, item))
          );
          container.appendChild(div);
        });
      }

      function renderHistory() {
        const container = el("historyContainer");
        container.innerHTML = "";
        if (!state.history.length) {
          container.innerHTML = '<span class="text-muted small">لا يوجد سجل.</span>';
          return;
        }
        state.history.slice(-8).forEach((item) => {
          const pill = document.createElement("button");
          pill.className = "btn btn-sm btn-outline-primary history-pill";
          pill.textContent = item.name;
          pill.addEventListener("click", () => loadSurah(item.id));
          container.appendChild(pill);
        });
      }

      async function loadChapters() {
        try {
          updateStatus("chapters", true, "... جارِ التحميل");
          const data = await apiRequest("/chapters", { params: { language: "ar" } });
          state.chapters = data.chapters;
          renderChapters();
          updateStatus("chapters", true, "متصل");
        } catch (error) {
          updateStatus("chapters", false, "تعذر التحميل");
        }
      }

      async function loadTranslations() {
        try {
          const data = await apiRequest("/resources/translations");
          const select = el("translationSelect");
          select.innerHTML = "";
          const preferredLanguages = ["Arabic", "English", "Urdu"];
          const preferredTranslations = data.translations.filter((t) =>
            preferredLanguages.includes(t.language_name)
          );
          preferredTranslations.slice(0, 20).forEach((translation) => {
            const option = document.createElement("option");
            option.value = translation.id;
            option.textContent = `${translation.language_name} - ${translation.author_name}`;
            if (translation.id === state.translationId) option.selected = true;
            select.appendChild(option);
          });
          const hasCurrent = [...select.options].some(
            (option) => Number(option.value) === Number(state.translationId)
          );
          if (!hasCurrent) {
            const fallback = data.translations.find(
              (translation) => translation.id === state.translationId
            );
            if (fallback) {
              const option = document.createElement("option");
              option.value = fallback.id;
              option.textContent = `${fallback.language_name} - ${fallback.author_name}`;
              option.selected = true;
              select.appendChild(option);
            }
          }
        } catch (error) {
          console.error(error);
        }
      }

      async function loadSurah(id, append = false) {
        if (state.controllers.verses) state.controllers.verses.abort();
        const controller = new AbortController();
        state.controllers.verses = controller;
        const fallback = state.currentChapter && state.currentChapter.id === id
          ? state.currentChapter
          : {
              id,
              name_arabic: `سورة رقم ${id}`,
              name_simple: `Surah ${id}`,
              revelation_place: "Meccan",
            };
        state.currentChapter = state.chapters.find((c) => c.id === id) || fallback;
        if (!append) {
          state.versePagination.currentPage = 1;
          state.currentVerses = [];
          state.currentVerseIndex = -1;
          updatePlayerControls();
        }
        updateStatus("verses", true, "... جارِ التحميل");
        try {
          const data = await apiRequest(`/verses/by_chapter/${id}`, {
            signal: controller.signal,
            params: {
              language: "ar",
              translations: state.translationId,
              fields: "chapter_id,verse_key,verse_number",
              page: state.versePagination.currentPage,
              per_page: state.versePagination.perPage,
            },
          });
          el("currentSurahTitle").textContent = state.currentChapter?.name_arabic || "سورة";
          el("currentSurahInfo").textContent = `${state.currentChapter?.name_simple} • ${
            state.currentChapter?.revelation_place === "Meccan" ? "مكية" : "مدنية"
          }`;
          const pagination = data.pagination || {};
          state.versePagination.hasMore =
            (pagination.total_pages || 0) > (pagination.current_page || 0);
          el("loadMoreContainer").hidden = !state.versePagination.hasMore;
          renderVerses(data.verses, append);
          updateStatus("verses", true, "متصل");
          if (!append) {
            state.history = [
              ...state.history.filter((item) => item.id !== id),
              { id, name: state.currentChapter?.name_arabic },
            ].slice(-12);
            renderHistory();
            filterChapters();
          }
          persistState();
        } catch (error) {
          if (error.name !== "AbortError") {
            updateStatus("verses", false, "تعذر التحميل");
          }
        }
      }

      async function loadMoreVerses() {
        if (!state.currentChapter || !state.versePagination.hasMore) return;
        state.versePagination.currentPage += 1;
        return loadSurah(state.currentChapter.id, true);
      }

      async function loadRandomAyah() {
        if (state.controllers.random) state.controllers.random.abort();
        const controller = new AbortController();
        state.controllers.random = controller;
        updateStatus("random", true, "... جارِ التحميل");
        try {
          const data = await apiRequest("/verses/random", {
            signal: controller.signal,
            params: {
              language: "ar",
              translations: state.translationId,
              fields: "verse_key",
            },
          });
          el("dailyAyahArabic").textContent = data.verse.text_uthmani;
          el("dailyAyahTranslation").textContent = data.verse.translations?.[0]?.text || "";
          el("dailyAyahArabic").dataset.verseKey = data.verse.verse_key;
          updateStatus("random", true, "متصل");
        } catch (error) {
          if (error.name !== "AbortError") updateStatus("random", false, "خطأ");
        }
      }

      async function runGlobalSearch() {
        const query = prompt("اكتب كلمة أو جملة للبحث في المصحف الكامل:");
        if (!query) return;
        if (state.controllers.search) state.controllers.search.abort();
        const controller = new AbortController();
        state.controllers.search = controller;
        updateStatus("search", true, "... جارِ البحث");
        try {
          const data = await apiRequest("/search", {
            signal: controller.signal,
            params: { language: "ar", size: 20, query },
          });
          const container = el("searchResults");
          container.innerHTML = "";
          data.search.results.forEach((result) => {
            const card = document.createElement("div");
            card.className = "search-result";
            card.innerHTML = `
              <strong>${result.verse_key}</strong>
              <p class="mb-1">${result.text}</p>
              <button class="btn btn-sm btn-outline-primary" data-key="${result.verse_key}">فتح الآية</button>`;
            card
              .querySelector("button")
              .addEventListener("click", () => openVerseFromKey(result.verse_key));
            container.appendChild(card);
          });
          el("searchPanel").hidden = false;
          updateStatus("search", true, "متصل");
        } catch (error) {
          if (error.name !== "AbortError") updateStatus("search", false, "تعذر");
        }
      }

      function openVerseFromKey(key) {
        const [chapterId] = key.split(":");
        loadSurah(parseInt(chapterId, 10)).then(() => {
          setTimeout(() => {
            const element = document.querySelector(`[data-verse-key="${key}"]`);
            if (element) {
              element.scrollIntoView({ behavior: "smooth", block: "center" });
              element.classList.add("highlight");
              setTimeout(() => element.classList.remove("highlight"), 3000);
            }
          }, 800);
        });
      }

      function handleVerseAction(event, verse) {
        const action = event.currentTarget.dataset.action;
        if (action === "play") {
          playVerse(verse);
        } else if (action === "copy") {
          navigator.clipboard.writeText(`${verse.text_uthmani} ( ${verse.verse_key} )`);
          showPlayerStatus("تم النسخ.");
        } else if (action === "bookmark") {
          const label = `${state.currentChapter?.name_arabic} - ${verse.verse_key}`;
          if (!state.bookmarks.some((item) => item.key === verse.verse_key)) {
            state.bookmarks.push({ key: verse.verse_key, label });
            renderBookmarks();
            persistState();
          }
        } else if (action === "download") {
          downloadVerseAudio(verse);
        }
      }

      function handleBookmarkAction(event, item) {
        const action = event.currentTarget.dataset.action;
        if (action === "open") {
          openVerseFromKey(item.key);
        } else if (action === "remove") {
          state.bookmarks = state.bookmarks.filter((bookmark) => bookmark.key !== item.key);
          renderBookmarks();
          persistState();
        }
      }

      function playVerse(verse) {
        if (!verse) return;
        const audio = el("globalAudio");
        const playerStatus = el("playerStatus");
        audio.src = `${AUDIO_CDN}/${verse.id}.mp3`;
        audio
          .play()
          .then(() => {
            updatePlayButtonIcon();
          })
          .catch(() => {
            showPlayerStatus("اضغط على زر التشغيل في مشغل الصوت للسماح بالتشغيل.");
          });
        playerStatus.textContent = `${state.currentChapter?.name_arabic} • ${verse.verse_key}`;
        if ("mediaSession" in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: `سورة ${state.currentChapter?.name_arabic}`,
            artist: "الشيخ محمد أيوب",
            album: "المصحف المرتل",
          });
        }
        setCurrentVerseIndex(verse.verse_key);
        updatePlayingVerseStyles();
      }

      function showPlayerStatus(text) {
        el("playerStatus").textContent = text;
        setTimeout(() => (el("playerStatus").textContent = ""), 3000);
      }

      function downloadVerseAudio(verse) {
        const link = document.createElement("a");
        link.href = `${AUDIO_CDN}/${verse.id}.mp3`;
        link.download = `verse-${verse.verse_key}.mp3`;
        link.rel = "noopener";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showPlayerStatus("تم تجهيز التحميل.");
      }

      function setCurrentVerseIndex(key) {
        state.currentVerseIndex = state.currentVerses.findIndex(
          (verse) => verse.verse_key === key
        );
        updatePlayerControls();
      }

      function updatePlayingVerseStyles() {
        document.querySelectorAll(".verse-card.playing").forEach((card) =>
          card.classList.remove("playing")
        );
        const currentKey = state.currentVerses[state.currentVerseIndex]?.verse_key;
        if (currentKey) {
          const node = document.querySelector(`[data-verse-key="${currentKey}"]`);
          if (node) node.classList.add("playing");
        }
      }

      async function playNextVerse(autoTriggered = false) {
        if (!state.currentVerses.length) return;
        if (state.currentVerseIndex === -1) {
          playVerse(state.currentVerses[0]);
          return;
        }
        const targetIndex = state.currentVerseIndex + 1;
        if (targetIndex < state.currentVerses.length) {
          playVerse(state.currentVerses[targetIndex]);
          return;
        }
        if (state.versePagination.hasMore) {
          await loadMoreVerses();
          if (state.currentVerseIndex + 1 < state.currentVerses.length) {
            playVerse(state.currentVerses[state.currentVerseIndex + 1]);
            return;
          }
        }
        if (autoTriggered) {
          showPlayerStatus("انتهت آيات السورة الحالية.");
        }
      }

      function playPreviousVerse() {
        if (!state.currentVerses.length) return;
        const targetIndex = state.currentVerseIndex - 1;
        if (targetIndex >= 0) {
          playVerse(state.currentVerses[targetIndex]);
        }
      }

      function updatePlayerControls() {
        const prevBtn = el("prevVerseBtn");
        const nextBtn = el("nextVerseBtn");
        const hasVerses = state.currentVerses.length > 0;
        if (prevBtn) {
          prevBtn.disabled = !hasVerses || state.currentVerseIndex <= 0;
        }
        if (nextBtn) {
          nextBtn.disabled =
            !hasVerses ||
            (!state.versePagination.hasMore &&
              state.currentVerseIndex >= state.currentVerses.length - 1);
        }
      }

      function toggleAutoAdvance() {
        state.autoAdvance = !state.autoAdvance;
        updateAutoAdvanceButton();
        persistState();
      }

      function updateAutoAdvanceButton() {
        const btn = el("autoAdvanceToggle");
        if (!btn) return;
        btn.textContent = `التشغيل المتتالي: ${state.autoAdvance ? "مفعل" : "متوقف"}`;
        btn.classList.toggle("btn-outline-success", state.autoAdvance);
        btn.classList.toggle("btn-outline-secondary", !state.autoAdvance);
      }

      function updatePlayButtonIcon() {
        const btn = el("playCurrentVerse");
        const audio = el("globalAudio");
        if (!btn || !audio) return;
        btn.innerHTML = audio.paused
          ? '<i class="bi bi-play-fill"></i>'
          : '<i class="bi bi-pause-fill"></i>';
      }

      function exportBookmarks() {
        if (!state.bookmarks.length) return alert("لا توجد إشارات للتصدير.");
        const blob = new Blob([JSON.stringify(state.bookmarks, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "bookmarks.json";
        link.click();
        URL.revokeObjectURL(url);
      }

      function filterChapters() {
        const text = el("chapterSearch").value || "";
        const quickText = el("chapterQuickSearch").value || "";
        const place = el("revelationFilter").value;
        const rawQuery = (text + " " + quickText).trim();
        const query = rawQuery.toLowerCase();
        const filtered = state.chapters.filter((chapter) => {
          const translatedName = chapter.translated_name?.name || "";
          const matchesText =
            (rawQuery && chapter.name_arabic.includes(rawQuery)) ||
            chapter.name_simple.toLowerCase().includes(query) ||
            translatedName.toLowerCase().includes(query);
          const matchesPlace = place === "all" || chapter.revelation_place === place;
          return matchesText && matchesPlace;
        });
        renderChapters(filtered);
      }

      document.addEventListener("DOMContentLoaded", () => {
        restoreState();
        loadChapters();
        loadTranslations();
        loadRandomAyah();
        updateAutoAdvanceButton();
        updatePlayerControls();
        const audio = el("globalAudio");
        audio.addEventListener("ended", () => {
          updatePlayButtonIcon();
          if (state.autoAdvance) {
            playNextVerse(true);
          }
        });
        audio.addEventListener("play", updatePlayButtonIcon);
        audio.addEventListener("pause", updatePlayButtonIcon);
        updatePlayButtonIcon();
        if ("mediaSession" in navigator) {
          try {
            navigator.mediaSession.setActionHandler("nexttrack", () => playNextVerse());
            navigator.mediaSession.setActionHandler("previoustrack", playPreviousVerse);
            navigator.mediaSession.setActionHandler("play", () => audio.play());
            navigator.mediaSession.setActionHandler("pause", () => audio.pause());
          } catch (error) {
            console.warn("MediaSession handlers unavailable", error);
          }
        }
      });

      el("themeToggle").addEventListener("click", () =>
        setTheme(state.theme === "dark" ? "light" : "dark")
      );
      el("translationSelect").addEventListener("change", (event) => {
        state.translationId = Number(event.target.value);
        if (state.currentChapter) loadSurah(state.currentChapter.id);
        loadRandomAyah();
        persistState();
      });
      el("fontSizeRange").addEventListener("input", (event) => {
        const value = `${event.target.value}rem`;
        document.documentElement.style.setProperty("--verse-font-size", value);
        persistState();
      });
      el("globalSearchBtn").addEventListener("click", runGlobalSearch);
      el("closeSearch").addEventListener("click", () => {
        el("searchPanel").hidden = true;
      });
      el("loadMoreVerses").addEventListener("click", loadMoreVerses);
      el("refreshDaily").addEventListener("click", loadRandomAyah);
      el("dailyAyahArabic").addEventListener("click", () => {
        const key = el("dailyAyahArabic").dataset.verseKey;
        if (key) openVerseFromKey(key);
      });
      el("clearBookmarks").addEventListener("click", () => {
        if (confirm("مسح جميع الإشارات؟")) {
          state.bookmarks = [];
          renderBookmarks();
          persistState();
        }
      });
      el("exportBookmarks").addEventListener("click", exportBookmarks);
      el("clearHistory").addEventListener("click", () => {
        state.history = [];
        renderHistory();
        persistState();
      });
      el("chapterSearch").addEventListener("input", filterChapters);
      el("chapterQuickSearch").addEventListener("input", filterChapters);
      el("revelationFilter").addEventListener("change", filterChapters);
      el("verseSearch").addEventListener("input", (event) => {
        const value = event.target.value.trim().toLowerCase();
        document.querySelectorAll(".verse-card").forEach((card) => {
          const text = card.innerText.toLowerCase();
          card.hidden = value && !text.includes(value);
        });
      });
      el("playCurrentVerse").addEventListener("click", () => {
        if (state.currentVerseIndex >= 0) {
          playVerse(state.currentVerses[state.currentVerseIndex]);
        } else if (state.currentVerses.length) {
          playVerse(state.currentVerses[0]);
        }
      });
      el("nextVerseBtn").addEventListener("click", () => playNextVerse());
      el("prevVerseBtn").addEventListener("click", playPreviousVerse);
      el("autoAdvanceToggle").addEventListener("click", toggleAutoAdvance);
    </script>
  </body>
</html>
